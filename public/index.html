<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario - Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            color: #333;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

        /* Header */
        .header {
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header h1 { font-size: 1.5rem; }
        .header .status { font-size: 0.875rem; color: #22c55e; }
        .header .status.off { color: #ef4444; }
        .header-actions { display: flex; gap: 10px; }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.875rem;
        }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-secondary { background: #e5e7eb; color: #333; }
        .btn-danger { background: #ef4444; color: white; }
        .btn:hover { opacity: 0.9; }

        /* Stats */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stat-value { font-size: 2rem; font-weight: 700; }
        .stat-label { font-size: 0.875rem; color: #666; }
        .stat-card.warning .stat-value { color: #f59e0b; }
        .stat-card.danger .stat-value { color: #ef4444; }
        .stat-card.success .stat-value { color: #22c55e; }
        .stat-card.info .stat-value { color: #3b82f6; }

        /* Comparaci√≥n Panel */
        .comparacion-panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .comparacion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .comparacion-header h2 { font-size: 1.1rem; }
        .progreso-bar {
            background: #e5e7eb;
            height: 24px;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        .progreso-fill {
            height: 100%;
            background: linear-gradient(90deg, #22c55e, #3b82f6);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.875rem;
            transition: width 0.5s;
        }
        .comparacion-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }
        @media (max-width: 768px) {
            .comparacion-stats { grid-template-columns: repeat(2, 1fr); }
        }
        .comp-stat {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            background: #f9fafb;
        }
        .comp-stat.faltante { background: #fef2f2; }
        .comp-stat.faltante .comp-value { color: #ef4444; }
        .comp-stat.sobrante { background: #f0fdf4; }
        .comp-stat.sobrante .comp-value { color: #22c55e; }
        .comp-value { font-size: 1.5rem; font-weight: 700; }
        .comp-label { font-size: 0.75rem; color: #666; margin-top: 4px; }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 2px solid #e5e7eb;
            margin-bottom: 15px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            font-weight: 500;
            color: #666;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }
        .tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Main layout */
        .main { display: grid; grid-template-columns: 300px 1fr; gap: 20px; }
        @media (max-width: 900px) { .main { grid-template-columns: 1fr; } }

        /* Panel */
        .panel {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .panel-header {
            padding: 15px 20px;
            border-bottom: 1px solid #e5e7eb;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .panel-content { padding: 15px; max-height: 500px; overflow-y: auto; }

        /* Zonas */
        .zona-card {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #e5e7eb;
        }
        .zona-card.activa { border-left-color: #22c55e; }
        .zona-nombre { font-weight: 600; font-size: 1rem; }
        .zona-info { font-size: 0.875rem; color: #666; margin-top: 5px; }
        .zona-stats { display: flex; gap: 15px; margin-top: 8px; font-size: 0.875rem; }
        .zona-auditor { color: #3b82f6; font-weight: 500; }

        /* Items table */
        .items-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }
        .items-table th, .items-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        .items-table th {
            background: #f9fafb;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        .items-table tr:hover { background: #f9fafb; }
        .items-table .ean { font-family: monospace; }
        .items-table .no-maestro { color: #ef4444; }
        .items-table .cantidad {
            font-weight: 600;
            text-align: center;
        }
        .items-table .acciones { white-space: nowrap; }
        .items-table .acciones button {
            padding: 4px 8px;
            margin-right: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
        }
        .btn-edit { background: #3b82f6; color: white; }
        .btn-delete { background: #ef4444; color: white; }

        /* Filtros */
        .filtros {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .filtros select, .filtros input {
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 0.875rem;
        }
        .filtros input { flex: 1; min-width: 200px; }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 12px;
            width: 100%;
            max-width: 450px;
        }
        .modal h3 { margin-bottom: 20px; }
        .modal .form-group { margin-bottom: 15px; }
        .modal label { display: block; margin-bottom: 5px; font-weight: 500; }
        .modal input, .modal select {
            width: 100%;
            padding: 10px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
        }
        .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }

        /* Empty state */
        .empty { text-align: center; padding: 40px; color: #666; }

        /* Modal de actualizaci√≥n obligatoria */
        .update-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }
        .update-modal.visible { display: flex; }
        .update-content {
            background: white;
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            max-width: 450px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }
        .update-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }
        .update-content h2 {
            margin-bottom: 15px;
            color: #1e40af;
        }
        .update-content p {
            color: #666;
            margin-bottom: 25px;
            line-height: 1.6;
        }
        .update-versions {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 25px;
            font-family: monospace;
        }
        .update-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        .update-btn:hover { background: #2563eb; }
        .update-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .update-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #fff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
            vertical-align: middle;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

    </style>
</head>
<body>
    <!-- Modal de actualizaci√≥n obligatoria -->
    <div id="updateModal" class="update-modal">
        <div class="update-content">
            <div class="update-icon">üîÑ</div>
            <h2>Actualizaci√≥n Disponible</h2>
            <p>Hay una nueva versi√≥n del sistema. Debes actualizar para continuar usando la aplicaci√≥n.</p>
            <div class="update-versions">
                <div>Versi√≥n actual: <strong id="versionActual">-</strong></div>
                <div>Nueva versi√≥n: <strong id="versionNueva">-</strong></div>
            </div>
            <button id="btnActualizar" class="update-btn" onclick="aplicarActualizacion()">
                Actualizar Ahora
            </button>
        </div>
    </div>

    <div class="container">
        <header class="header">
            <div>
                <h1>Sistema de Inventario</h1>
                <span class="status" id="status">‚óè Conectado</span>
                <span id="tiendaActual" style="display:none; margin-left:15px; padding:4px 10px; background:#8b5cf6; color:white; border-radius:4px; font-size:12px;"></span>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="mostrarModalHistorico()" style="background:#8b5cf6;color:white;">Historico</button>
                <button class="btn btn-secondary" onclick="exportarExcel()">Exportar Excel</button>
                <button class="btn btn-secondary" onclick="mostrarModalMaestro()">Cargar Maestro</button>
                <button class="btn btn-secondary" onclick="mostrarModalStock()">Cargar Stock Tienda</button>
                <button class="btn btn-primary" onclick="mostrarModalSesion()">Nueva Sesi√≥n</button>
            </div>
        </header>

        <section class="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalItems">0</div>
                <div class="stat-label">Total Items</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="eansUnicos">0</div>
                <div class="stat-label">EANs √önicos</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="zonasActivas">0</div>
                <div class="stat-label">Zonas</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="escaneres">0</div>
                <div class="stat-label">Auditores</div>
            </div>
            <div class="stat-card" id="sinMaestroCard">
                <div class="stat-value" id="sinMaestro">0</div>
                <div class="stat-label">Sin Maestro</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="maestroCargado">0</div>
                <div class="stat-label">Productos Maestro</div>
            </div>
        </section>

        <!-- Panel de Comparaci√≥n -->
        <section class="comparacion-panel" id="comparacionPanel" style="display: none;">
            <div class="comparacion-header">
                <h2>Comparaci√≥n con Stock Tienda</h2>
                <span id="stockNombre" style="color:#666; font-size:0.875rem;"></span>
            </div>
            <div class="progreso-bar">
                <div class="progreso-fill" id="progresoFill" style="width: 0%;">
                    <span id="progresoTexto">0%</span>
                </div>
            </div>
            <div class="comparacion-stats">
                <div class="comp-stat">
                    <div class="comp-value" id="compEsperados">0</div>
                    <div class="comp-label">Items Esperados</div>
                </div>
                <div class="comp-stat">
                    <div class="comp-value" id="compContados">0</div>
                    <div class="comp-label">Items Contados</div>
                </div>
                <div class="comp-stat">
                    <div class="comp-value" id="compDiferencia">0</div>
                    <div class="comp-label" id="compDiferenciaLabel">Por Contar</div>
                </div>
                <div class="comp-stat faltante">
                    <div class="comp-value" id="compFaltantes">0</div>
                    <div class="comp-label">Faltantes</div>
                </div>
                <div class="comp-stat sobrante">
                    <div class="comp-value" id="compSobrantes">0</div>
                    <div class="comp-label">Sobrantes</div>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 15px;">
                <div style="text-align: center; padding: 15px; background: #fef2f2; border-radius: 8px;">
                    <div style="font-size: 0.75rem; color: #666;">Costo Faltantes</div>
                    <div style="font-size: 1.25rem; font-weight: 700; color: #ef4444;" id="costoFaltantes">$0</div>
                </div>
                <div style="text-align: center; padding: 15px; background: #f0fdf4; border-radius: 8px;">
                    <div style="font-size: 0.75rem; color: #666;">Costo Sobrantes</div>
                    <div style="font-size: 1.25rem; font-weight: 700; color: #22c55e;" id="costoSobrantes">$0</div>
                </div>
                <div style="text-align: center; padding: 15px; background: #eff6ff; border-radius: 8px;">
                    <div style="font-size: 0.75rem; color: #666;">Cruce (Diferencia)</div>
                    <div style="font-size: 1.25rem; font-weight: 700;" id="costoCruce">$0</div>
                </div>
            </div>
            <div style="margin-top: 15px; text-align: center;">
                <button class="btn btn-secondary" onclick="verDetalleFaltantes()" style="margin-right: 10px;">Ver Faltantes</button>
                <button class="btn btn-secondary" onclick="verDetalleSobrantes()">Ver Sobrantes</button>
            </div>
        </section>

        <main class="main">
            <section class="panel">
                <div class="panel-header">
                    <span>Zonas y Auditores</span>
                </div>
                <div class="panel-content" id="zonasPanel">
                    <div class="empty">Sin zonas activas</div>
                </div>
            </section>

            <section class="panel">
                <div class="panel-header">
                    <span>Items Escaneados</span>
                    <div style="display:flex;align-items:center;gap:10px;">
                        <button class="btn btn-secondary" onclick="mostrarAgregarZona()" style="font-size:12px;padding:6px 12px;">+ Zona</button>
                        <button class="btn btn-primary" onclick="mostrarAgregarItem()" style="font-size:12px;padding:6px 12px;">+ Item</button>
                        <span id="itemsCount">0</span>
                    </div>
                </div>
                <div class="panel-content" style="max-height: none; padding: 0;">
                    <div class="filtros" style="padding: 15px; border-bottom: 1px solid #e5e7eb;">
                        <select id="filtroZona" onchange="filtrarItems()">
                            <option value="">Todas las zonas</option>
                        </select>
                        <input type="text" id="filtroBuscar" placeholder="Buscar EAN o descripci√≥n..." oninput="filtrarItems()">
                    </div>
                    <div style="max-height: 500px; overflow-y: auto;">
                        <table class="items-table">
                            <thead>
                                <tr>
                                    <th>Zona</th>
                                    <th>EAN</th>
                                    <th>Descripci√≥n</th>
                                    <th>Cant.</th>
                                    <th>Auditor</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="itemsBody">
                                <tr><td colspan="6" class="empty">Sin escaneos</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal Nueva Sesi√≥n -->
    <div class="modal" id="modalSesion">
        <div class="modal-content">
            <h3>Nueva Sesi√≥n</h3>
            <p style="color:#666;margin-bottom:15px;">Esto limpiar√° todos los datos actuales.</p>
            <div class="form-group">
                <label>Tienda *</label>
                <select id="selectTienda" onchange="actualizarNombreSesion()">
                    <option value="">-- Seleccionar tienda --</option>
                </select>
            </div>
            <div class="form-group">
                <label>Nombre de la sesi√≥n</label>
                <input type="text" id="nombreSesion" placeholder="Inventario Enero 2024">
            </div>
            <div class="form-group">
                <label>Detalles / Comentarios</label>
                <textarea id="detallesSesion" placeholder="Observaciones, notas relevantes..." style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:6px;height:60px;resize:vertical;"></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button>
                <button class="btn btn-primary" onclick="iniciarSesion()">Iniciar</button>
            </div>
        </div>
    </div>

    <!-- Modal Agregar Tienda -->
    <div class="modal" id="modalAgregarTienda">
        <div class="modal-content">
            <h3>Agregar Nueva Tienda</h3>
            <div class="form-group">
                <label>N√∫mero de Almac√©n *</label>
                <input type="text" id="nuevaTiendaNumero" placeholder="Ej: 1050">
            </div>
            <div class="form-group">
                <label>Nombre de la Tienda *</label>
                <input type="text" id="nuevaTiendaNombre" placeholder="Ej: Mall Plaza Norte">
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="cerrarModalAgregarTienda()">Cancelar</button>
                <button class="btn btn-primary" onclick="confirmarAgregarTienda()">Agregar</button>
            </div>
        </div>
    </div>

    <!-- Modal Cargar Maestro -->
    <div class="modal" id="modalMaestro">
        <div class="modal-content">
            <h3>Cargar Maestro</h3>
            <p style="color:#666;margin-bottom:15px;">Archivo Excel con columnas: EAN, C√≥digo, Descripci√≥n, Costo</p>
            <div class="form-group">
                <input type="file" id="archivoMaestro" accept=".xlsx,.xls,.csv">
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button>
                <button class="btn btn-primary" onclick="cargarMaestro()">Cargar</button>
            </div>
        </div>
    </div>

    <!-- Modal Cargar Stock Tienda -->
    <div class="modal" id="modalStock">
        <div class="modal-content">
            <h3>Cargar Stock Tienda</h3>
            <p style="color:#666;margin-bottom:15px;">Archivo Excel con columnas: EAN, Cantidad</p>
            <p style="color:#888;font-size:12px;margin-bottom:15px;">(El costo se obtiene del Maestro)</p>
            <div class="form-group">
                <input type="file" id="archivoStock" accept=".xlsx,.xls,.csv">
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button>
                <button class="btn btn-primary" onclick="cargarStock()">Cargar</button>
            </div>
        </div>
    </div>

    <!-- Modal Detalle Faltantes -->
    <div class="modal" id="modalFaltantes">
        <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
            <h3>Items Faltantes</h3>
            <p style="color:#666;margin-bottom:15px;">Productos que no han sido escaneados</p>
            <div id="listaFaltantes" style="max-height: 400px; overflow-y: auto;"></div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="cerrarModales()">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal Detalle Sobrantes -->
    <div class="modal" id="modalSobrantes">
        <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
            <h3>Items Sobrantes</h3>
            <p style="color:#666;margin-bottom:15px;">Productos escaneados de m√°s o no esperados</p>
            <div id="listaSobrantes" style="max-height: 400px; overflow-y: auto;"></div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="cerrarModales()">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal Editar Item -->
    <div class="modal" id="modalEditar">
        <div class="modal-content">
            <h3>Editar Item</h3>
            <div class="form-group">
                <label>EAN</label>
                <input type="text" id="editEan" readonly style="background:#f5f5f5;">
            </div>
            <div class="form-group">
                <label>Descripci√≥n</label>
                <input type="text" id="editDesc">
            </div>
            <div class="form-group">
                <label>Cantidad</label>
                <input type="number" id="editCantidad" min="1">
            </div>
            <div class="form-group">
                <label>Zona</label>
                <select id="editZona"></select>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarEdicion()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal Confirmar Eliminar Item -->
    <div class="modal" id="modalEliminar">
        <div class="modal-content">
            <h3>Eliminar Item</h3>
            <p style="margin-bottom:20px;">¬øEst√°s seguro de eliminar este item?</p>
            <p><strong id="eliminarEan"></strong></p>
            <p style="color:#666;" id="eliminarDesc"></p>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button>
                <button class="btn btn-danger" onclick="confirmarEliminar()">Eliminar</button>
            </div>
        </div>
    </div>

    <!-- Modal Agregar Zona -->
    <div class="modal" id="modalAgregarZona">
        <div class="modal-content">
            <h3>Agregar Zona</h3>
            <div class="form-group">
                <label>Asignar a auditor *</label>
                <select id="nuevaZonaAuditor" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:6px;">
                    <option value="">-- Selecciona un auditor --</option>
                </select>
                <small id="sinAuditoresMsg" style="color:#f59e0b;display:none;margin-top:5px;">No hay auditores conectados. La zona quedar√° sin asignar.</small>
            </div>
            <div class="form-group">
                <label>Nombre de la zona *</label>
                <input type="text" id="nuevaZonaNombre" placeholder="Ej: Pasillo 1, Bodega, etc.">
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button>
                <button class="btn btn-primary" onclick="confirmarAgregarZona()">Crear Zona</button>
            </div>
        </div>
    </div>

    <!-- Modal Editar Zona -->
    <div class="modal" id="modalEditarZona">
        <div class="modal-content">
            <h3>Editar Zona</h3>
            <div class="form-group">
                <label>Nombre de la zona</label>
                <input type="text" id="editZonaNombre">
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarEdicionZona()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal Eliminar Zona -->
    <div class="modal" id="modalEliminarZona">
        <div class="modal-content">
            <h3>Eliminar Zona</h3>
            <p style="margin-bottom:15px; color:#ef4444;">¬°Atenci√≥n! Esto eliminar√° la zona y todos sus items.</p>
            <p>¬øEliminar la zona <strong id="eliminarZonaNombre"></strong>?</p>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button>
                <button class="btn btn-danger" onclick="confirmarEliminarZona()">Eliminar</button>
            </div>
        </div>
    </div>

    <!-- Modal Hist√≥rico -->
    <div class="modal" id="modalHistorico">
        <div class="modal-content" style="max-width: 900px; max-height: 85vh; overflow: hidden; display: flex; flex-direction: column;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3>Historial de Inventarios</h3>
                <div>
                    <button class="btn btn-secondary" onclick="mostrarAgregarTienda()" style="margin-right:10px;">+ Nueva Tienda</button>
                    <button class="btn btn-primary" onclick="mostrarGuardarHistorico()" style="margin-right:10px;">Guardar Actual</button>
                    <button class="btn btn-secondary" id="btnGestionUsuarios" onclick="mostrarGestionUsuarios()" style="display:none;">Usuarios</button>
                </div>
            </div>
            <div id="usuarioActualInfo" style="margin-bottom:15px; padding:10px; background:#f3f4f6; border-radius:6px; font-size:13px;"></div>
            <div style="flex:1; overflow-y:auto;">
                <table class="items-table" style="font-size:0.85rem;">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Tienda</th>
                            <th>Items</th>
                            <th>Faltantes</th>
                            <th>Sobrantes</th>
                            <th>Costo General</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="historicoBody">
                        <tr><td colspan="7" class="empty">Cargando...</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="modal-actions" style="margin-top:15px;">
                <button class="btn btn-secondary" onclick="cerrarModales()">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal Guardar en Hist√≥rico -->
    <div class="modal" id="modalGuardarHistorico">
        <div class="modal-content">
            <h3>Guardar en Hist√≥rico</h3>
            <p style="color:#666;margin-bottom:15px;">Guarda el resultado del inventario actual</p>
            <div class="form-group">
                <label>Nombre de la Tienda *</label>
                <input type="text" id="guardarTienda" placeholder="Ej: Tienda Centro">
            </div>
            <div class="form-group">
                <label>Notas (opcional)</label>
                <textarea id="guardarNotas" placeholder="Observaciones..." style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:6px;height:80px;resize:vertical;"></textarea>
            </div>
            <div style="background:#f3f4f6;padding:15px;border-radius:8px;margin-bottom:15px;">
                <div style="font-size:13px;color:#666;margin-bottom:8px;">Resumen a guardar:</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:13px;">
                    <div>Items escaneados: <strong id="resumenItems">0</strong></div>
                    <div>Zonas: <strong id="resumenZonas">0</strong></div>
                    <div style="color:#ef4444;">Faltantes: <strong id="resumenFaltantes">0</strong></div>
                    <div style="color:#22c55e;">Sobrantes: <strong id="resumenSobrantes">0</strong></div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="cerrarModalGuardar()">Cancelar</button>
                <button class="btn btn-primary" onclick="confirmarGuardarHistorico()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal Ver Detalle Hist√≥rico -->
    <div class="modal" id="modalDetalleHistorico">
        <div class="modal-content" style="max-width: 700px; max-height: 80vh; overflow-y: auto;">
            <h3>Detalle del Inventario</h3>
            <div id="detalleHistoricoContent"></div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="cerrarModalDetalle()">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal Editar Hist√≥rico -->
    <div class="modal" id="modalEditarHistorico">
        <div class="modal-content">
            <h3>Editar Registro</h3>
            <div class="form-group">
                <label>Nombre de la Tienda</label>
                <input type="text" id="editHistTienda">
            </div>
            <div class="form-group">
                <label>Notas</label>
                <textarea id="editHistNotas" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:6px;height:80px;resize:vertical;"></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="cerrarModalEditHist()">Cancelar</button>
                <button class="btn btn-primary" onclick="confirmarEditarHistorico()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal Confirmar Eliminar Hist√≥rico -->
    <div class="modal" id="modalEliminarHistorico">
        <div class="modal-content">
            <h3>Eliminar Registro</h3>
            <p style="color:#ef4444;margin-bottom:15px;">Esta acci√≥n no se puede deshacer.</p>
            <p>¬øEliminar el registro de <strong id="elimHistTienda"></strong>?</p>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="cerrarModalElimHist()">Cancelar</button>
                <button class="btn btn-danger" onclick="confirmarEliminarHistorico()">Eliminar</button>
            </div>
        </div>
    </div>

    <!-- Modal Gesti√≥n de Usuarios -->
    <div class="modal" id="modalUsuarios">
        <div class="modal-content" style="max-width: 600px;">
            <h3>Gesti√≥n de Usuarios</h3>
            <button class="btn btn-primary" onclick="mostrarCrearUsuario()" style="margin-bottom:15px;">+ Nuevo Usuario</button>
            <table class="items-table" style="font-size:0.85rem;">
                <thead>
                    <tr>
                        <th>Usuario</th>
                        <th>Nombre</th>
                        <th>Rol</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="usuariosBody">
                    <tr><td colspan="5" class="empty">Cargando...</td></tr>
                </tbody>
            </table>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="cerrarModalUsuarios()">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal Crear/Editar Usuario -->
    <div class="modal" id="modalEditarUsuario">
        <div class="modal-content">
            <h3 id="tituloModalUsuario">Nuevo Usuario</h3>
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="editUsuarioUsername" placeholder="usuario123">
            </div>
            <div class="form-group">
                <label>Nombre Completo</label>
                <input type="text" id="editUsuarioNombre" placeholder="Juan P√©rez">
            </div>
            <div class="form-group">
                <label>Contrase√±a</label>
                <input type="password" id="editUsuarioPassword" placeholder="Dejar vac√≠o para no cambiar">
            </div>
            <div class="form-group">
                <label>Rol</label>
                <select id="editUsuarioRol">
                    <option value="auditor">Auditor</option>
                    <option value="admin">Administrador</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="cerrarModalEditUsuario()">Cancelar</button>
                <button class="btn btn-primary" onclick="confirmarGuardarUsuario()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal Agregar Item -->
    <div class="modal" id="modalAgregarItem">
        <div class="modal-content">
            <h3>Agregar Item</h3>
            <div class="form-group">
                <label>Zona *</label>
                <select id="agregarZonaSelect">
                    <option value="">-- Seleccionar zona --</option>
                </select>
            </div>
            <div class="form-group">
                <label>EAN / C√≥digo de Barras *</label>
                <input type="text" id="agregarEan" placeholder="Escanear o escribir EAN" oninput="buscarEnMaestro()">
            </div>
            <div class="form-group">
                <label>Descripci√≥n</label>
                <input type="text" id="agregarDesc" placeholder="Se autocompleta del maestro">
            </div>
            <div class="form-group">
                <label>Cantidad</label>
                <input type="number" id="agregarCantidad" value="1" min="1">
            </div>
            <div id="infoMaestro" style="padding:10px; background:#f0fdf4; border-radius:6px; font-size:13px; display:none; margin-bottom:15px;">
                <span style="color:#22c55e;">‚úì Encontrado en maestro</span>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="cerrarModales()">Cancelar</button>
                <button class="btn btn-primary" onclick="confirmarAgregarItem()">Agregar</button>
            </div>
        </div>
    </div>

    <script>
        let ws;
        let todosLosItems = [];
        let todasLasZonas = [];
        let datosActuales = null; // Estado actual del servidor
        let itemEditando = null;
        let itemEliminando = null;
        let zonaEditando = null;
        let zonaEliminando = null;
        let comparacionData = null;

        // === WEBSOCKET ===
        function conectar() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}`);

            ws.onopen = () => {
                document.getElementById('status').textContent = '‚óè Conectado';
                document.getElementById('status').className = 'status';
            };

            ws.onclose = () => {
                document.getElementById('status').textContent = '‚óè Desconectado';
                document.getElementById('status').className = 'status off';
                setTimeout(conectar, 2000);
            };

            ws.onmessage = (e) => {
                const msg = JSON.parse(e.data);
                manejarMensaje(msg);
            };
        }

        function manejarMensaje(msg) {
            switch(msg.tipo) {
                case 'estado_inicial':
                case 'estado':
                case 'actualizacion':
                    actualizarDashboard(msg.data);
                    break;
                case 'nuevo_escaneo':
                    actualizarDashboard(msg.data.resumen);
                    cargarItems();
                    break;
                case 'lista_zonas':
                case 'lista_zonas_dashboard':
                    todasLasZonas = msg.data.zonas || [];
                    actualizarFiltroZonas();
                    break;
                case 'maestro_cargado':
                    alert(`Maestro cargado: ${msg.data.cantidad} productos`);
                    cargarEstado();
                    break;
                case 'stock_tienda_cargado':
                    alert(`Stock Tienda cargado: ${msg.data.cantidad} productos`);
                    cargarComparacion();
                    break;
                case 'item_actualizado':
                case 'item_eliminado':
                case 'item_agregado':
                case 'zona_creada':
                case 'zona_actualizada':
                case 'zona_eliminada':
                    cargarEstado();
                    break;
                case 'nueva_sesion':
                    // Limpiar datos locales y recargar estado
                    todosLosItems = [];
                    todasLasZonas = [];
                    cargarEstado();
                    break;
                case 'update_disponible':
                    mostrarModalActualizacion(msg.data);
                    break;
                case 'reiniciando':
                    document.getElementById('btnActualizar').innerHTML = '<span class="update-spinner"></span>Reiniciando...';
                    document.getElementById('btnActualizar').disabled = true;
                    setTimeout(() => location.reload(), 5000);
                    break;
            }
        }

        // Funciones de actualizaci√≥n
        function mostrarModalActualizacion(data) {
            document.getElementById('versionActual').textContent = data.versionLocal;
            document.getElementById('versionNueva').textContent = data.versionRemota;
            document.getElementById('updateModal').classList.add('visible');
        }

        function aplicarActualizacion() {
            const btn = document.getElementById('btnActualizar');
            btn.innerHTML = '<span class="update-spinner"></span>Actualizando...';
            btn.disabled = true;

            fetch('/api/update/aplicar', { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    if (data.ok) {
                        btn.innerHTML = '<span class="update-spinner"></span>Reiniciando...';
                        setTimeout(() => location.reload(), 5000);
                    } else {
                        alert('Error: ' + data.error);
                        btn.innerHTML = 'Actualizar Ahora';
                        btn.disabled = false;
                    }
                })
                .catch(err => {
                    alert('Error de conexi√≥n');
                    btn.innerHTML = 'Actualizar Ahora';
                    btn.disabled = false;
                });
        }

        function actualizarDashboard(data) {
            datosActuales = data; // Guardar estado actual
            document.getElementById('totalItems').textContent = data.totalItems || 0;
            document.getElementById('eansUnicos').textContent = data.eansUnicos || 0;
            document.getElementById('zonasActivas').textContent = data.zonas?.length || 0;
            document.getElementById('escaneres').textContent = data.auditoresUnicos || 0;
            document.getElementById('sinMaestro').textContent = data.sinMaestro || 0;
            document.getElementById('maestroCargado').textContent = data.maestroCargado || 0;

            // Mostrar tienda actual si hay sesi√≥n activa
            const tiendaEl = document.getElementById('tiendaActual');
            if (data.sesionActiva && data.sesionActiva.tienda_nombre) {
                tiendaEl.textContent = `${data.sesionActiva.tienda_numero ? '[' + data.sesionActiva.tienda_numero + '] ' : ''}${data.sesionActiva.tienda_nombre}`;
                tiendaEl.style.display = 'inline-block';
                // Guardar tienda en localStorage para el hist√≥rico
                localStorage.setItem('inventario_tienda', JSON.stringify({
                    id: data.sesionActiva.tienda_id,
                    numero_almacen: data.sesionActiva.tienda_numero,
                    nombre: data.sesionActiva.tienda_nombre
                }));
            } else {
                tiendaEl.style.display = 'none';
            }

            const sinMaestroCard = document.getElementById('sinMaestroCard');
            sinMaestroCard.className = 'stat-card' + (data.sinMaestro > 0 ? ' danger' : '');

            todasLasZonas = data.zonas || [];
            // No sobrescribir todosLosItems aqu√≠, se carga por separado con /api/items

            actualizarZonas(data.zonas || [], data.escaneres || []);
            actualizarFiltroZonas();

            // Si hay stock tienda cargado, actualizar comparaci√≥n
            if (data.stockTiendaCargado) {
                cargarComparacion();
            }
        }

        function actualizarZonas(zonas, escaneres) {
            const panel = document.getElementById('zonasPanel');

            if (zonas.length === 0 && escaneres.length === 0) {
                panel.innerHTML = '<div class="empty">Sin zonas activas</div>';
                return;
            }

            let html = '';

            // Mostrar todas las zonas con info del auditor
            zonas.forEach(zona => {
                const auditor = zona.escaner || zona.creadoPor;
                html += `
                    <div class="zona-card ${zona.escaner ? 'activa' : ''}">
                        <div style="display:flex; justify-content:space-between; align-items:start;">
                            <div>
                                <div class="zona-nombre">${zona.nombre}</div>
                                <div class="zona-auditor">${auditor ? auditor : 'Sin auditor'}</div>
                            </div>
                            <div style="display:flex; gap:5px;">
                                <button onclick="editarZona('${zona.id}', '${zona.nombre.replace(/'/g, "\\'")}')" style="padding:4px 8px; background:#3b82f6; color:white; border:none; border-radius:4px; cursor:pointer; font-size:11px;">Editar</button>
                                <button onclick="eliminarZona('${zona.id}', '${zona.nombre.replace(/'/g, "\\'")}')" style="padding:4px 8px; background:#ef4444; color:white; border:none; border-radius:4px; cursor:pointer; font-size:11px;">X</button>
                            </div>
                        </div>
                        <div class="zona-stats">
                            <span>${zona.totalItems || 0} items</span>
                            <span>${zona.eansUnicos || 0} EANs</span>
                        </div>
                    </div>
                `;
            });

            panel.innerHTML = html;
        }

        function actualizarFiltroZonas() {
            const select = document.getElementById('filtroZona');
            const editSelect = document.getElementById('editZona');
            const current = select.value;

            select.innerHTML = '<option value="">Todas las zonas</option>';
            editSelect.innerHTML = '';

            todasLasZonas.forEach(z => {
                select.innerHTML += `<option value="${z.id}">${z.nombre}</option>`;
                editSelect.innerHTML += `<option value="${z.id}">${z.nombre}</option>`;
            });

            select.value = current;
        }

        function filtrarItems() {
            const zonaFiltro = document.getElementById('filtroZona').value;
            const buscar = document.getElementById('filtroBuscar').value.toLowerCase();

            let items = todosLosItems;

            if (zonaFiltro) {
                items = items.filter(i => i.zonaId === zonaFiltro);
            }

            if (buscar) {
                items = items.filter(i =>
                    i.ean.toLowerCase().includes(buscar) ||
                    i.descripcion.toLowerCase().includes(buscar)
                );
            }

            renderItems(items);
            document.getElementById('itemsCount').textContent = items.length;
        }

        function renderItems(items) {
            const tbody = document.getElementById('itemsBody');

            if (items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty">Sin resultados</td></tr>';
                return;
            }

            tbody.innerHTML = items.map(item => `
                <tr>
                    <td>${item.zonaNombre || item.zonaId || '-'}</td>
                    <td class="ean ${!item.existeEnMaestro ? 'no-maestro' : ''}">${item.ean}</td>
                    <td>${item.descripcion}</td>
                    <td class="cantidad">${item.cantidad}</td>
                    <td>${item.escaner || '-'}</td>
                    <td class="acciones">
                        <button class="btn-edit" onclick="editarItem('${item.id}')">Editar</button>
                        <button class="btn-delete" onclick="eliminarItem('${item.id}')">Eliminar</button>
                    </td>
                </tr>
            `).join('');
        }

        // === ACCIONES ===
        async function cargarItems() {
            try {
                const res = await fetch('/api/items');
                todosLosItems = await res.json();
                filtrarItems();
            } catch (e) {
                console.error('Error cargando items:', e);
            }
        }

        async function cargarEstado() {
            // Cargar estado general
            const res = await fetch('/api/estado');
            const data = await res.json();
            actualizarDashboard(data);

            // Cargar todos los items
            await cargarItems();
        }

        function exportarExcel() {
            window.location.href = '/api/exportar';
        }

        let tiendasData = [];
        let tiendaSeleccionada = null;

        async function mostrarModalSesion() {
            await cargarTiendas();
            document.getElementById('nombreSesion').value = '';
            document.getElementById('selectTienda').value = '';
            tiendaSeleccionada = null;
            document.getElementById('modalSesion').classList.add('active');
        }

        async function cargarTiendas() {
            try {
                const res = await fetch('/api/tiendas');
                tiendasData = await res.json();
                const select = document.getElementById('selectTienda');
                select.innerHTML = '<option value="">-- Seleccionar tienda --</option>';
                tiendasData.forEach(t => {
                    select.innerHTML += `<option value="${t.id}" data-numero="${t.numero_almacen}" data-nombre="${t.nombre}">${t.numero_almacen} - ${t.nombre}</option>`;
                });
            } catch (e) {
                console.error('Error cargando tiendas:', e);
            }
        }

        function actualizarNombreSesion() {
            const select = document.getElementById('selectTienda');
            const option = select.options[select.selectedIndex];

            if (option && option.value) {
                const nombre = option.dataset.nombre;
                const fecha = new Date().toLocaleDateString('es-CL');
                document.getElementById('nombreSesion').value = `Inventario ${nombre} - ${fecha}`;
                tiendaSeleccionada = {
                    id: parseInt(option.value),
                    numero_almacen: option.dataset.numero,
                    nombre: nombre
                };
            } else {
                tiendaSeleccionada = null;
            }
        }

        let volverAHistorico = false;

        function mostrarAgregarTienda() {
            // Si viene desde hist√≥rico, recordar para volver
            if (document.getElementById('modalHistorico').classList.contains('active')) {
                volverAHistorico = true;
                document.getElementById('modalHistorico').classList.remove('active');
            }
            document.getElementById('nuevaTiendaNumero').value = '';
            document.getElementById('nuevaTiendaNombre').value = '';
            document.getElementById('modalAgregarTienda').classList.add('active');
            document.getElementById('nuevaTiendaNumero').focus();
        }

        function cerrarModalAgregarTienda() {
            document.getElementById('modalAgregarTienda').classList.remove('active');
            // Volver al hist√≥rico si ven√≠a de ah√≠
            if (volverAHistorico) {
                volverAHistorico = false;
                document.getElementById('modalHistorico').classList.add('active');
            }
        }

        async function confirmarAgregarTienda() {
            const numero = document.getElementById('nuevaTiendaNumero').value.trim();
            const nombre = document.getElementById('nuevaTiendaNombre').value.trim();

            if (!numero || !nombre) {
                alert('N√∫mero de almac√©n y nombre son requeridos');
                return;
            }

            try {
                const res = await fetch('/api/tiendas', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ numero_almacen: numero, nombre: nombre })
                });

                const data = await res.json();
                if (data.ok) {
                    alert('Tienda creada: ' + numero + ' - ' + nombre);
                    document.getElementById('modalAgregarTienda').classList.remove('active');

                    // Volver al hist√≥rico o actualizar select de tiendas
                    if (volverAHistorico) {
                        volverAHistorico = false;
                        document.getElementById('modalHistorico').classList.add('active');
                    } else {
                        await cargarTiendas();
                        document.getElementById('selectTienda').value = data.id;
                        actualizarNombreSesion();
                    }
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (e) {
                alert('Error de conexi√≥n');
            }
        }

        function mostrarModalMaestro() {
            document.getElementById('modalMaestro').classList.add('active');
        }

        function cerrarModales() {
            document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
        }

        async function iniciarSesion() {
            const nombre = document.getElementById('nombreSesion').value;
            const detalles = document.getElementById('detallesSesion').value.trim();

            if (!tiendaSeleccionada) {
                alert('Selecciona una tienda');
                return;
            }

            // Guardar tienda seleccionada en localStorage para usarla al guardar hist√≥rico
            localStorage.setItem('inventario_tienda', JSON.stringify(tiendaSeleccionada));

            await fetch('/api/sesion/nueva', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    nombre: nombre,
                    detalles: detalles,
                    tienda_id: tiendaSeleccionada.id,
                    tienda_nombre: tiendaSeleccionada.nombre,
                    tienda_numero: tiendaSeleccionada.numero_almacen
                })
            });
            cerrarModales();
            document.getElementById('nombreSesion').value = '';
            document.getElementById('detallesSesion').value = '';
        }

        async function cargarMaestro() {
            const input = document.getElementById('archivoMaestro');
            if (!input.files[0]) {
                alert('Selecciona un archivo');
                return;
            }

            const formData = new FormData();
            formData.append('archivo', input.files[0]);

            const res = await fetch('/api/maestro/cargar', {
                method: 'POST',
                body: formData
            });

            const result = await res.json();
            if (res.ok) {
                cerrarModales();
                input.value = '';
            } else {
                alert(result.error || 'Error al cargar');
            }
        }

        function editarItem(id) {
            const item = todosLosItems.find(i => i.id === id);
            if (!item) return;

            itemEditando = item;
            document.getElementById('editEan').value = item.ean;
            document.getElementById('editDesc').value = item.descripcion;
            document.getElementById('editCantidad').value = item.cantidad;
            document.getElementById('editZona').value = item.zonaId;
            document.getElementById('modalEditar').classList.add('active');
        }

        async function guardarEdicion() {
            if (!itemEditando) return;

            const data = {
                id: itemEditando.id,
                descripcion: document.getElementById('editDesc').value,
                cantidad: parseInt(document.getElementById('editCantidad').value),
                zonaId: document.getElementById('editZona').value
            };

            await fetch('/api/item/editar', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });

            cerrarModales();
            itemEditando = null;
            cargarEstado();
        }

        function eliminarItem(id) {
            const item = todosLosItems.find(i => i.id === id);
            if (!item) return;

            itemEliminando = item;
            document.getElementById('eliminarEan').textContent = item.ean;
            document.getElementById('eliminarDesc').textContent = item.descripcion;
            document.getElementById('modalEliminar').classList.add('active');
        }

        async function confirmarEliminar() {
            if (!itemEliminando) return;

            await fetch('/api/item/eliminar', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({id: itemEliminando.id, zonaId: itemEliminando.zonaId})
            });

            cerrarModales();
            itemEliminando = null;
            cargarEstado();
        }

        // === ZONAS ===
        function mostrarAgregarZona() {
            document.getElementById('nuevaZonaNombre').value = '';

            // Poblar dropdown con auditores conectados
            const select = document.getElementById('nuevaZonaAuditor');
            const msgSinAuditores = document.getElementById('sinAuditoresMsg');
            select.innerHTML = '<option value="">-- Selecciona un auditor --</option>';

            // Obtener auditores √∫nicos del estado actual (usando datosActuales)
            const auditoresUnicos = [];
            const nombresVistos = new Set();

            if (datosActuales && datosActuales.escaneres) {
                datosActuales.escaneres.forEach(esc => {
                    const nombreNorm = esc.nombre.toLowerCase().trim();
                    if (!nombresVistos.has(nombreNorm)) {
                        nombresVistos.add(nombreNorm);
                        auditoresUnicos.push({
                            nombre: esc.nombre,
                            nombreNormalizado: nombreNorm
                        });
                    }
                });
            }

            if (auditoresUnicos.length === 0) {
                msgSinAuditores.style.display = 'block';
            } else {
                msgSinAuditores.style.display = 'none';
                auditoresUnicos.forEach(aud => {
                    const option = document.createElement('option');
                    option.value = JSON.stringify(aud);
                    option.textContent = aud.nombre;
                    select.appendChild(option);
                });
            }

            document.getElementById('modalAgregarZona').classList.add('active');
            document.getElementById('nuevaZonaNombre').focus();
        }

        async function confirmarAgregarZona() {
            const nombre = document.getElementById('nuevaZonaNombre').value.trim();
            const auditorSelect = document.getElementById('nuevaZonaAuditor');
            const auditorValue = auditorSelect.value;

            if (!nombre) {
                alert('Ingresa un nombre para la zona');
                return;
            }

            // Parsear auditor seleccionado
            let auditorNombre = null;
            let auditorNombreNormalizado = null;

            if (auditorValue) {
                try {
                    const auditor = JSON.parse(auditorValue);
                    auditorNombre = auditor.nombre;
                    auditorNombreNormalizado = auditor.nombreNormalizado;
                } catch (e) {}
            }

            const zonaId = 'zona_' + Date.now();

            const res = await fetch('/api/zona/crear', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    zonaId,
                    nombre,
                    auditorNombre,
                    auditorNombreNormalizado
                })
            });

            const result = await res.json();
            if (res.ok) {
                cerrarModales();
                cargarEstado();
            } else {
                alert(result.error || 'Error al crear zona');
            }
        }

        function editarZona(zonaId, zonaNombre) {
            zonaEditando = zonaId;
            document.getElementById('editZonaNombre').value = zonaNombre;
            document.getElementById('modalEditarZona').classList.add('active');
        }

        async function guardarEdicionZona() {
            if (!zonaEditando) return;

            const nuevoNombre = document.getElementById('editZonaNombre').value.trim();
            if (!nuevoNombre) {
                alert('Ingresa un nombre para la zona');
                return;
            }

            await fetch('/api/zona/editar', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({zonaId: zonaEditando, nuevoNombre})
            });

            cerrarModales();
            zonaEditando = null;
            cargarEstado();
        }

        function eliminarZona(zonaId, zonaNombre) {
            zonaEliminando = zonaId;
            document.getElementById('eliminarZonaNombre').textContent = zonaNombre;
            document.getElementById('modalEliminarZona').classList.add('active');
        }

        async function confirmarEliminarZona() {
            if (!zonaEliminando) return;

            await fetch('/api/zona/eliminar', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({zonaId: zonaEliminando})
            });

            cerrarModales();
            zonaEliminando = null;
            cargarEstado();
        }

        // === AGREGAR ITEM ===
        let maestroCache = [];

        function mostrarAgregarItem() {
            // Poblar select de zonas
            const select = document.getElementById('agregarZonaSelect');
            select.innerHTML = '<option value="">-- Seleccionar zona --</option>';
            todasLasZonas.forEach(z => {
                select.innerHTML += `<option value="${z.id}">${z.nombre}</option>`;
            });

            document.getElementById('agregarEan').value = '';
            document.getElementById('agregarDesc').value = '';
            document.getElementById('agregarCantidad').value = '1';
            document.getElementById('infoMaestro').style.display = 'none';
            document.getElementById('modalAgregarItem').classList.add('active');
            document.getElementById('agregarEan').focus();
        }

        let buscarTimeout = null;
        async function buscarEnMaestro() {
            const ean = document.getElementById('agregarEan').value.trim();
            const infoEl = document.getElementById('infoMaestro');

            if (ean.length < 3) {
                infoEl.style.display = 'none';
                return;
            }

            // Debounce para evitar muchas peticiones
            if (buscarTimeout) clearTimeout(buscarTimeout);

            // Solo buscar cuando el EAN tenga longitud razonable (8+ d√≠gitos)
            if (ean.length >= 8) {
                buscarTimeout = setTimeout(async () => {
                    try {
                        // Buscar directamente en el servidor
                        const res = await fetch(`/api/maestro/buscar/${encodeURIComponent(ean)}`);
                        const data = await res.json();

                        if (data.encontrado && data.producto) {
                            document.getElementById('agregarDesc').value = data.producto.descripcion;
                            infoEl.innerHTML = '<span style="color:#22c55e;">‚úì Encontrado en maestro</span>';
                            infoEl.style.background = '#f0fdf4';
                            infoEl.style.display = 'block';
                        } else {
                            infoEl.innerHTML = '<span style="color:#f59e0b;">‚ö† No encontrado en maestro</span>';
                            infoEl.style.background = '#fefce8';
                            infoEl.style.display = 'block';
                        }
                    } catch (e) {
                        console.error('Error buscando en maestro:', e);
                    }
                }, 300);
            }
        }

        async function confirmarAgregarItem() {
            const zonaId = document.getElementById('agregarZonaSelect').value;
            const ean = document.getElementById('agregarEan').value.trim();
            const descripcion = document.getElementById('agregarDesc').value.trim();
            const cantidad = parseInt(document.getElementById('agregarCantidad').value) || 1;

            if (!zonaId) {
                alert('Selecciona una zona');
                return;
            }

            if (!ean) {
                alert('Ingresa un EAN');
                return;
            }

            const res = await fetch('/api/item/agregar', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    ean,
                    descripcion: descripcion || 'SIN DESCRIPCION',
                    cantidad,
                    zonaId: zonaId
                })
            });

            const result = await res.json();
            if (res.ok) {
                cerrarModales();
                cargarEstado();
            } else {
                alert(result.error || 'Error al agregar');
            }
        }

        // === STOCK TIENDA Y COMPARACI√ìN ===
        function mostrarModalStock() {
            document.getElementById('modalStock').classList.add('active');
        }

        async function cargarStock() {
            const input = document.getElementById('archivoStock');
            if (!input.files[0]) {
                alert('Selecciona un archivo');
                return;
            }

            const formData = new FormData();
            formData.append('archivo', input.files[0]);

            const res = await fetch('/api/stock-tienda/cargar', {
                method: 'POST',
                body: formData
            });

            const result = await res.json();
            if (res.ok) {
                cerrarModales();
                input.value = '';
            } else {
                alert(result.error || 'Error al cargar');
            }
        }

        async function cargarComparacion() {
            try {
                const res = await fetch('/api/comparacion');
                const data = await res.json();
                comparacionData = data;
                actualizarPanelComparacion(data);
            } catch (e) {
                console.error('Error cargando comparaci√≥n:', e);
            }
        }

        function actualizarPanelComparacion(data) {
            const panel = document.getElementById('comparacionPanel');

            if (!data || !data.tieneStock || data.totalEsperado === 0) {
                panel.style.display = 'none';
                return;
            }

            panel.style.display = 'block';

            // Progreso
            const porcentaje = data.progreso || 0;
            document.getElementById('progresoFill').style.width = Math.min(porcentaje, 100) + '%';
            document.getElementById('progresoTexto').textContent = porcentaje + '%';

            // Stats
            document.getElementById('compEsperados').textContent = data.totalEsperado || 0;
            document.getElementById('compContados').textContent = data.totalEscaneado || 0;
            document.getElementById('compFaltantes').textContent = data.totalFaltantes || 0;
            document.getElementById('compSobrantes').textContent = data.totalSobrantes || 0;

            // Diferencia entre esperados y contados
            const diferencia = (data.totalEsperado || 0) - (data.totalEscaneado || 0);
            const difEl = document.getElementById('compDiferencia');
            const difLabelEl = document.getElementById('compDiferenciaLabel');
            difEl.textContent = Math.abs(diferencia);
            if (diferencia > 0) {
                difEl.style.color = '#f59e0b';
                difLabelEl.textContent = 'Por Contar';
            } else if (diferencia < 0) {
                difEl.style.color = '#22c55e';
                difLabelEl.textContent = 'De M√°s';
            } else {
                difEl.style.color = '#22c55e';
                difLabelEl.textContent = 'Completo';
            }

            // Costos
            document.getElementById('costoFaltantes').textContent = formatearMoneda(data.costoFaltante || 0);
            document.getElementById('costoSobrantes').textContent = formatearMoneda(data.costoSobrante || 0);

            // Cruce (diferencia): sobrantes - faltantes
            const cruce = (data.costoSobrante || 0) - (data.costoFaltante || 0);
            const cruceEl = document.getElementById('costoCruce');
            cruceEl.textContent = formatearMoneda(Math.abs(cruce));
            cruceEl.style.color = cruce >= 0 ? '#22c55e' : '#ef4444';
            cruceEl.textContent = (cruce >= 0 ? '+' : '-') + formatearMoneda(Math.abs(cruce));
        }

        function formatearMoneda(valor) {
            return '$' + valor.toLocaleString('es-CL', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }

        function verDetalleFaltantes() {
            if (!comparacionData || !comparacionData.faltantes) return;

            const lista = document.getElementById('listaFaltantes');
            const items = comparacionData.faltantes;

            if (items.length === 0) {
                lista.innerHTML = '<div class="empty">Sin faltantes</div>';
            } else {
                lista.innerHTML = `
                    <table class="items-table" style="font-size:0.8rem;">
                        <thead>
                            <tr>
                                <th>EAN</th>
                                <th>Descripci√≥n</th>
                                <th>Esperado</th>
                                <th>Contado</th>
                                <th>Faltan</th>
                                <th>Costo</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${items.map(i => `
                                <tr>
                                    <td class="ean">${i.ean}</td>
                                    <td>${i.descripcion}</td>
                                    <td style="text-align:center;">${i.cantidadEsperada}</td>
                                    <td style="text-align:center;">${i.cantidadEscaneada}</td>
                                    <td style="text-align:center; color:#ef4444; font-weight:600;">${i.diferencia}</td>
                                    <td style="color:#ef4444;">${formatearMoneda(i.costoTotal)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }

            document.getElementById('modalFaltantes').classList.add('active');
        }

        function verDetalleSobrantes() {
            if (!comparacionData || !comparacionData.sobrantes) return;

            const lista = document.getElementById('listaSobrantes');
            const items = comparacionData.sobrantes;

            if (items.length === 0) {
                lista.innerHTML = '<div class="empty">Sin sobrantes</div>';
            } else {
                lista.innerHTML = `
                    <table class="items-table" style="font-size:0.8rem;">
                        <thead>
                            <tr>
                                <th>EAN</th>
                                <th>Descripci√≥n</th>
                                <th>Esperado</th>
                                <th>Contado</th>
                                <th>Sobran</th>
                                <th>Costo</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${items.map(i => `
                                <tr>
                                    <td class="ean">${i.ean}</td>
                                    <td>${i.descripcion}</td>
                                    <td style="text-align:center;">${i.cantidadEsperada}</td>
                                    <td style="text-align:center;">${i.cantidadEscaneada}</td>
                                    <td style="text-align:center; color:#22c55e; font-weight:600;">+${i.diferencia}</td>
                                    <td style="color:#22c55e;">${formatearMoneda(i.costoTotal)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }

            document.getElementById('modalSobrantes').classList.add('active');
        }

        // Cerrar modales con Escape
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') cerrarModales();
        });

        // Verificar actualizaciones
        function verificarActualizaciones() {
            fetch('/api/update/check')
                .then(r => r.json())
                .then(data => {
                    if (data.updateDisponible) {
                        mostrarModalActualizacion(data);
                    }
                })
                .catch(() => {});
        }

        // ============================================
        // HISTORICO Y USUARIOS
        // ============================================
        let usuarioActual = null;
        let historicoData = [];
        let editandoHistoricoId = null;
        let eliminandoHistoricoId = null;
        let editandoUsuarioId = null;

        // Cargar sesi√≥n desde GUI al iniciar
        function cargarSesionGUI() {
            // Intentar leer sesi√≥n del GUI (Electron)
            const sessionStr = localStorage.getItem('inventario_session');
            if (sessionStr) {
                try {
                    const session = JSON.parse(sessionStr);
                    const diasExpiracion = 7;
                    const now = Date.now();
                    if (now - session.timestamp < diasExpiracion * 24 * 60 * 60 * 1000) {
                        usuarioActual = session.usuario;
                    }
                } catch (e) {
                    // Sesi√≥n inv√°lida
                }
            }
        }

        // Cargar al inicio
        cargarSesionGUI();

        // Mostrar modal de hist√≥rico
        async function mostrarModalHistorico() {
            document.getElementById('modalHistorico').classList.add('active');

            // Recargar sesi√≥n por si cambi√≥
            cargarSesionGUI();

            const esAdmin = usuarioActual && usuarioActual.rol === 'admin';

            if (usuarioActual) {
                document.getElementById('usuarioActualInfo').innerHTML = `
                    <span>Usuario: <strong>${usuarioActual.nombre}</strong></span>
                    <span style="margin-left:15px;padding:3px 8px;background:${usuarioActual.rol === 'admin' ? '#8b5cf6' : '#3b82f6'};color:white;border-radius:4px;font-size:11px;">${usuarioActual.rol}</span>
                `;
                // Mostrar bot√≥n de usuarios solo para admin
                document.getElementById('btnGestionUsuarios').style.display = esAdmin ? 'inline-block' : 'none';
            } else {
                document.getElementById('usuarioActualInfo').innerHTML = `
                    <span style="color:#666;">Para editar o eliminar registros, inicia sesi√≥n desde la aplicaci√≥n de escritorio.</span>
                `;
                document.getElementById('btnGestionUsuarios').style.display = 'none';
            }

            await cargarHistorico();
        }

        async function cargarHistorico() {
            try {
                const res = await fetch('/api/historico');
                historicoData = await res.json();
                renderHistorico();
            } catch (e) {
                document.getElementById('historicoBody').innerHTML = '<tr><td colspan="7" class="empty">Error al cargar</td></tr>';
            }
        }

        function renderHistorico() {
            const tbody = document.getElementById('historicoBody');
            const esAdmin = usuarioActual && usuarioActual.rol === 'admin';

            if (historicoData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty">Sin registros en el hist√≥rico</td></tr>';
                return;
            }

            tbody.innerHTML = historicoData.map(h => `
                <tr>
                    <td>${new Date(h.fecha).toLocaleDateString('es-CL')} ${new Date(h.fecha).toLocaleTimeString('es-CL', {hour:'2-digit',minute:'2-digit'})}</td>
                    <td>
                        ${h.numero_almacen ? '<small style="color:#3b82f6;font-weight:600;">[' + h.numero_almacen + ']</small> ' : ''}
                        <strong>${h.nombre_tienda}</strong>
                        ${h.nombre_sesion ? '<br><small style="color:#666;">' + h.nombre_sesion + '</small>' : ''}
                    </td>
                    <td>${h.total_items_escaneados}</td>
                    <td style="color:#ef4444;">${h.total_faltantes} <small>(${formatearMoneda(h.costo_faltantes)})</small></td>
                    <td style="color:#22c55e;">${h.total_sobrantes} <small>(${formatearMoneda(h.costo_sobrantes)})</small></td>
                    <td style="font-weight:600;color:${h.costo_general >= 0 ? '#22c55e' : '#ef4444'};">${formatearMoneda(h.costo_general)}</td>
                    <td>
                        <button class="btn-edit" onclick="verDetalleHistorico(${h.id})" style="font-size:11px;">Ver</button>
                        <button class="btn-edit" onclick="descargarHistorico(${h.id})" style="font-size:11px;background:#22c55e;">Descargar</button>
                        ${esAdmin ? `
                            <button class="btn-edit" onclick="editarHistorico(${h.id})" style="font-size:11px;">Editar</button>
                            <button class="btn-delete" onclick="eliminarHistorico(${h.id})" style="font-size:11px;">Eliminar</button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');
        }

        function descargarHistorico(id) {
            window.location.href = `/api/historico/${id}/exportar`;
        }

        // Login se maneja desde la aplicaci√≥n de escritorio (GUI)
        // Las funciones de login del dashboard fueron removidas

        function mostrarGuardarHistorico() {
            // Cargar tienda de la sesi√≥n si existe
            const tiendaGuardada = localStorage.getItem('inventario_tienda');
            if (tiendaGuardada) {
                try {
                    const tienda = JSON.parse(tiendaGuardada);
                    document.getElementById('guardarTienda').value = tienda.nombre;
                    document.getElementById('guardarTienda').dataset.tiendaId = tienda.id;
                    document.getElementById('guardarTienda').dataset.tiendaNumero = tienda.numero_almacen;
                } catch (e) {
                    document.getElementById('guardarTienda').value = '';
                }
            } else {
                document.getElementById('guardarTienda').value = '';
            }

            document.getElementById('guardarNotas').value = '';

            // Mostrar resumen
            const comp = comparacionData || { totalFaltantes: 0, totalSobrantes: 0 };

            document.getElementById('resumenItems').textContent = document.getElementById('totalItems').textContent;
            document.getElementById('resumenZonas').textContent = document.getElementById('zonasActivas').textContent;
            document.getElementById('resumenFaltantes').textContent = comp.totalFaltantes || 0;
            document.getElementById('resumenSobrantes').textContent = comp.totalSobrantes || 0;

            document.getElementById('modalGuardarHistorico').classList.add('active');
        }

        function cerrarModalGuardar() {
            document.getElementById('modalGuardarHistorico').classList.remove('active');
        }

        async function confirmarGuardarHistorico() {
            const tiendaInput = document.getElementById('guardarTienda');
            const tienda = tiendaInput.value.trim();
            const notas = document.getElementById('guardarNotas').value.trim();

            if (!tienda) {
                alert('Ingresa el nombre de la tienda');
                return;
            }

            // Obtener datos de tienda si est√°n en el input
            const tiendaId = tiendaInput.dataset.tiendaId || null;
            const tiendaNumero = tiendaInput.dataset.tiendaNumero || null;

            try {
                const res = await fetch('/api/historico', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        tienda_id: tiendaId ? parseInt(tiendaId) : null,
                        nombre_tienda: tienda,
                        numero_almacen: tiendaNumero,
                        notas: notas,
                        creado_por: usuarioActual?.nombre || 'An√≥nimo'
                    })
                });

                const data = await res.json();
                if (data.ok) {
                    alert('Guardado exitosamente');
                    cerrarModalGuardar();
                    cargarHistorico();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (e) {
                alert('Error de conexi√≥n');
            }
        }

        async function verDetalleHistorico(id) {
            try {
                const res = await fetch(`/api/historico/${id}`);
                const h = await res.json();

                const content = document.getElementById('detalleHistoricoContent');
                content.innerHTML = `
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:20px;">
                        <div><strong>Tienda:</strong> ${h.numero_almacen ? '[' + h.numero_almacen + '] ' : ''}${h.nombre_tienda}</div>
                        <div><strong>Fecha:</strong> ${new Date(h.fecha).toLocaleString('es-CL')}</div>
                        <div><strong>Sesi√≥n:</strong> ${h.nombre_sesion || '-'}</div>
                        <div><strong>Creado por:</strong> ${h.creado_por || '-'}</div>
                    </div>
                    ${h.detalles_sesion ? `<div style="background:#f0f9ff;padding:12px;border-radius:8px;margin-bottom:15px;border-left:4px solid #3b82f6;"><strong>Detalles:</strong> ${h.detalles_sesion}</div>` : ''}

                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px;">
                        <div style="background:#f3f4f6;padding:12px;border-radius:8px;text-align:center;">
                            <div style="font-size:1.5rem;font-weight:700;">${h.total_items_escaneados}</div>
                            <div style="font-size:12px;color:#666;">Items Escaneados</div>
                        </div>
                        <div style="background:#fef2f2;padding:12px;border-radius:8px;text-align:center;">
                            <div style="font-size:1.5rem;font-weight:700;color:#ef4444;">${h.total_faltantes}</div>
                            <div style="font-size:12px;color:#666;">Faltantes</div>
                        </div>
                        <div style="background:#f0fdf4;padding:12px;border-radius:8px;text-align:center;">
                            <div style="font-size:1.5rem;font-weight:700;color:#22c55e;">${h.total_sobrantes}</div>
                            <div style="font-size:12px;color:#666;">Sobrantes</div>
                        </div>
                    </div>

                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px;">
                        <div style="background:#fef2f2;padding:12px;border-radius:8px;text-align:center;">
                            <div style="font-size:1.1rem;font-weight:600;color:#ef4444;">${formatearMoneda(h.costo_faltantes)}</div>
                            <div style="font-size:11px;color:#666;">Costo Faltantes</div>
                        </div>
                        <div style="background:#f0fdf4;padding:12px;border-radius:8px;text-align:center;">
                            <div style="font-size:1.1rem;font-weight:600;color:#22c55e;">${formatearMoneda(h.costo_sobrantes)}</div>
                            <div style="font-size:11px;color:#666;">Costo Sobrantes</div>
                        </div>
                        <div style="background:#eff6ff;padding:12px;border-radius:8px;text-align:center;">
                            <div style="font-size:1.1rem;font-weight:600;color:${h.costo_general >= 0 ? '#22c55e' : '#ef4444'};">${formatearMoneda(h.costo_general)}</div>
                            <div style="font-size:11px;color:#666;">Costo General</div>
                        </div>
                    </div>

                    ${h.notas ? `<div style="background:#f9fafb;padding:12px;border-radius:8px;margin-bottom:15px;"><strong>Notas:</strong><br>${h.notas}</div>` : ''}

                    ${h.detalle_faltantes && h.detalle_faltantes.length > 0 ? `
                        <details style="margin-bottom:15px;">
                            <summary style="cursor:pointer;font-weight:600;color:#ef4444;margin-bottom:10px;">Ver Faltantes (${h.detalle_faltantes.length})</summary>
                            <div style="max-height:200px;overflow-y:auto;">
                                <table class="items-table" style="font-size:12px;">
                                    <thead><tr><th>EAN</th><th>Descripci√≥n</th><th>Esperado</th><th>Contado</th><th>Faltan</th></tr></thead>
                                    <tbody>
                                        ${h.detalle_faltantes.slice(0, 50).map(f => `
                                            <tr>
                                                <td class="ean">${f.ean}</td>
                                                <td>${f.descripcion}</td>
                                                <td>${f.cantidadEsperada}</td>
                                                <td>${f.cantidadEscaneada}</td>
                                                <td style="color:#ef4444;font-weight:600;">${f.diferencia}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </details>
                    ` : ''}

                    ${h.detalle_sobrantes && h.detalle_sobrantes.length > 0 ? `
                        <details>
                            <summary style="cursor:pointer;font-weight:600;color:#22c55e;margin-bottom:10px;">Ver Sobrantes (${h.detalle_sobrantes.length})</summary>
                            <div style="max-height:200px;overflow-y:auto;">
                                <table class="items-table" style="font-size:12px;">
                                    <thead><tr><th>EAN</th><th>Descripci√≥n</th><th>Esperado</th><th>Contado</th><th>Sobran</th></tr></thead>
                                    <tbody>
                                        ${h.detalle_sobrantes.slice(0, 50).map(s => `
                                            <tr>
                                                <td class="ean">${s.ean}</td>
                                                <td>${s.descripcion}</td>
                                                <td>${s.cantidadEsperada}</td>
                                                <td>${s.cantidadEscaneada}</td>
                                                <td style="color:#22c55e;font-weight:600;">+${s.diferencia}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </details>
                    ` : ''}
                `;

                document.getElementById('modalDetalleHistorico').classList.add('active');
            } catch (e) {
                alert('Error al cargar detalle');
            }
        }

        function cerrarModalDetalle() {
            document.getElementById('modalDetalleHistorico').classList.remove('active');
        }

        function editarHistorico(id) {
            const h = historicoData.find(x => x.id === id);
            if (!h) return;

            editandoHistoricoId = id;
            document.getElementById('editHistTienda').value = h.nombre_tienda;
            document.getElementById('editHistNotas').value = h.notas || '';
            document.getElementById('modalEditarHistorico').classList.add('active');
        }

        function cerrarModalEditHist() {
            document.getElementById('modalEditarHistorico').classList.remove('active');
            editandoHistoricoId = null;
        }

        async function confirmarEditarHistorico() {
            if (!editandoHistoricoId) return;

            const tienda = document.getElementById('editHistTienda').value.trim();
            const notas = document.getElementById('editHistNotas').value.trim();

            if (!tienda) {
                alert('Ingresa el nombre de la tienda');
                return;
            }

            try {
                const res = await fetch(`/api/historico/${editandoHistoricoId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ nombre_tienda: tienda, notas: notas })
                });

                const data = await res.json();
                if (data.ok) {
                    cerrarModalEditHist();
                    cargarHistorico();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (e) {
                alert('Error de conexi√≥n');
            }
        }

        function eliminarHistorico(id) {
            const h = historicoData.find(x => x.id === id);
            if (!h) return;

            eliminandoHistoricoId = id;
            document.getElementById('elimHistTienda').textContent = h.nombre_tienda;
            document.getElementById('modalEliminarHistorico').classList.add('active');
        }

        function cerrarModalElimHist() {
            document.getElementById('modalEliminarHistorico').classList.remove('active');
            eliminandoHistoricoId = null;
        }

        async function confirmarEliminarHistorico() {
            if (!eliminandoHistoricoId) return;

            try {
                const res = await fetch(`/api/historico/${eliminandoHistoricoId}`, {
                    method: 'DELETE'
                });

                const data = await res.json();
                if (data.ok) {
                    cerrarModalElimHist();
                    cargarHistorico();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (e) {
                alert('Error de conexi√≥n');
            }
        }

        // ============================================
        // GESTI√ìN DE USUARIOS
        // ============================================
        let usuariosData = [];

        async function mostrarGestionUsuarios() {
            document.getElementById('modalUsuarios').classList.add('active');
            await cargarUsuarios();
        }

        async function cargarUsuarios() {
            try {
                const res = await fetch('/api/usuarios');
                usuariosData = await res.json();
                renderUsuarios();
            } catch (e) {
                document.getElementById('usuariosBody').innerHTML = '<tr><td colspan="5" class="empty">Error al cargar</td></tr>';
            }
        }

        function renderUsuarios() {
            const tbody = document.getElementById('usuariosBody');

            if (usuariosData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty">Sin usuarios</td></tr>';
                return;
            }

            tbody.innerHTML = usuariosData.map(u => `
                <tr>
                    <td>${u.username}</td>
                    <td>${u.nombre}</td>
                    <td><span style="padding:2px 8px;background:${u.rol === 'admin' ? '#8b5cf6' : '#3b82f6'};color:white;border-radius:4px;font-size:11px;">${u.rol}</span></td>
                    <td>${u.activo ? '<span style="color:#22c55e;">Activo</span>' : '<span style="color:#ef4444;">Inactivo</span>'}</td>
                    <td>
                        <button class="btn-edit" onclick="editarUsuario(${u.id})" style="font-size:11px;">Editar</button>
                        ${u.username !== 'Andrespachacama' ? `<button class="btn-delete" onclick="eliminarUsuario(${u.id})" style="font-size:11px;">Eliminar</button>` : ''}
                    </td>
                </tr>
            `).join('');
        }

        function cerrarModalUsuarios() {
            document.getElementById('modalUsuarios').classList.remove('active');
        }

        function mostrarCrearUsuario() {
            editandoUsuarioId = null;
            document.getElementById('tituloModalUsuario').textContent = 'Nuevo Usuario';
            document.getElementById('editUsuarioUsername').value = '';
            document.getElementById('editUsuarioUsername').disabled = false;
            document.getElementById('editUsuarioNombre').value = '';
            document.getElementById('editUsuarioPassword').value = '';
            document.getElementById('editUsuarioPassword').placeholder = 'Contrase√±a';
            document.getElementById('editUsuarioRol').value = 'auditor';
            document.getElementById('modalEditarUsuario').classList.add('active');
        }

        function editarUsuario(id) {
            const u = usuariosData.find(x => x.id === id);
            if (!u) return;

            editandoUsuarioId = id;
            document.getElementById('tituloModalUsuario').textContent = 'Editar Usuario';
            document.getElementById('editUsuarioUsername').value = u.username;
            document.getElementById('editUsuarioUsername').disabled = true;
            document.getElementById('editUsuarioNombre').value = u.nombre;
            document.getElementById('editUsuarioPassword').value = '';
            document.getElementById('editUsuarioPassword').placeholder = 'Dejar vac√≠o para no cambiar';
            document.getElementById('editUsuarioRol').value = u.rol;
            document.getElementById('modalEditarUsuario').classList.add('active');
        }

        function cerrarModalEditUsuario() {
            document.getElementById('modalEditarUsuario').classList.remove('active');
            editandoUsuarioId = null;
        }

        async function confirmarGuardarUsuario() {
            const username = document.getElementById('editUsuarioUsername').value.trim();
            const nombre = document.getElementById('editUsuarioNombre').value.trim();
            const password = document.getElementById('editUsuarioPassword').value;
            const rol = document.getElementById('editUsuarioRol').value;

            if (!nombre) {
                alert('Ingresa el nombre');
                return;
            }

            if (editandoUsuarioId) {
                // Actualizar
                const datos = { nombre, rol };
                if (password) datos.password = password;

                try {
                    const res = await fetch(`/api/usuarios/${editandoUsuarioId}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(datos)
                    });

                    const data = await res.json();
                    if (data.ok) {
                        cerrarModalEditUsuario();
                        cargarUsuarios();
                    } else {
                        alert('Error: ' + data.error);
                    }
                } catch (e) {
                    alert('Error de conexi√≥n');
                }
            } else {
                // Crear nuevo
                if (!username || !password) {
                    alert('Usuario y contrase√±a son requeridos');
                    return;
                }

                try {
                    const res = await fetch('/api/usuarios', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ username, password, nombre, rol })
                    });

                    const data = await res.json();
                    if (data.ok) {
                        cerrarModalEditUsuario();
                        cargarUsuarios();
                    } else {
                        alert('Error: ' + data.error);
                    }
                } catch (e) {
                    alert('Error de conexi√≥n');
                }
            }
        }

        async function eliminarUsuario(id) {
            if (!confirm('¬øEliminar este usuario?')) return;

            try {
                const res = await fetch(`/api/usuarios/${id}`, {
                    method: 'DELETE'
                });

                const data = await res.json();
                if (data.ok) {
                    cargarUsuarios();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (e) {
                alert('Error de conexi√≥n');
            }
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            conectar();
            cargarEstado();
            cargarComparacion();
            // Verificar actualizaciones al cargar
            setTimeout(verificarActualizaciones, 3000);

            // Cargar usuario de sesi√≥n si existe
            const sessionData = localStorage.getItem('inventario_usuario');
            if (sessionData) {
                try {
                    usuarioActual = JSON.parse(sessionData);
                } catch (e) {}
            }
        });
    </script>
</body>
</html>
